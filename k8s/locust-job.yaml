apiVersion: batch/v1
kind: Job
metadata:
  name: locust-load-test
  labels:
    app: load-test
spec:
  # 设置作业失败前重试次数
  backoffLimit: 2
  # 设置作业完成后的保留时间（秒），0表示立即删除
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: load-test
    spec:
      restartPolicy: Never
      containers:
      - name: locust-master
        image: locustio/locust:latest
        command:
        - locust
        args:
        - -f
        - /mnt/locustfile.py
        - --host
        - http://desktop-pet-service:8080
        - --headless
        - --users
        - "50"
        - --spawn-rate
        - "5"
        - --run-time
        - "5m"
        - --html
        - /tmp/report.html
        env:
        - name: LOCUST_HOST
          value: "http://desktop-pet-service:8080"
        volumeMounts:
        - name: locustfile
          mountPath: /mnt/locustfile.py
          subPath: locustfile.py
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 512Mi
      volumes:
      - name: locustfile
        configMap:
          name: locustfile-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: locustfile-config
data:
  locustfile.py: |
    """
    负载测试脚本 - 使用Locust
    模拟并发用户测试AI Desktop Pet的性能
    
    在 Kubernetes 集群内运行，通过 Service 名称访问应用
    """
    
    from locust import HttpUser, task, between
    import json
    import random
    import os
    
    
    class DesktopPetUser(HttpUser):
        """模拟桌面宠物用户"""
        
        wait_time = between(1, 3)  # 用户操作间隔1-3秒
        
        def on_start(self):
            """用户启动时初始化"""
            self.user_id = f"test_user_{random.randint(1000, 9999)}"
            self.conversation_id = None
        
        @task(3)
        def send_message(self):
            """发送消息（权重3，更频繁）"""
            messages = [
                "Hello, how are you?",
                "What's the weather like?",
                "Tell me a joke",
                "How can you help me?",
                "What do you remember about me?",
                "你好",
                "今天天气怎么样？",
                "我有点累",
                "给我讲个笑话",
                "What's your favorite color?",
                "Can you help me with my work?",
                "I'm feeling stressed today",
            ]
            
            payload = {
                "user_id": self.user_id,
                "message": random.choice(messages)
            }
            
            with self.client.post(
                "/api/v1/chat",
                json=payload,
                catch_response=True
            ) as response:
                if response.status_code == 200:
                    data = response.json()
                    self.conversation_id = data.get("conversation_id")
                    response.success()
                else:
                    response.failure(f"Status code: {response.status_code}")
        
        @task(1)
        def get_conversation(self):
            """获取对话历史（权重1）"""
            self.client.get(f"/api/v1/conversation/{self.user_id}")
        
        @task(1)
        def get_profile(self):
            """获取用户档案（权重1）"""
            self.client.get(f"/api/v1/profile/{self.user_id}")
        
        @task(1)
        def health_check(self):
            """健康检查（权重1）"""
            self.client.get("/health")

